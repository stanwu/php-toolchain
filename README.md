# PHP Project Refactoring Toolchain

A powerful PHP project analysis and semi-automated refactoring toolchain. It scans an existing PHP project, identifies potential issues such as duplicate code, stale backup files, and poor directory structure, and produces an actionable refactoring plan.

## Features

*   **Project scanning**: Scans the entire PHP project and builds a detailed JSON report covering all files, classes, functions, and dependencies.
*   **Multi-dimensional analysis**:
    *   **Dependency analysis**: Detects `vendor` directories and analyses Composer dependencies.
    *   **Duplicate code analysis**: Finds duplicate or near-identical code blocks across the project.
    *   **Backup file analysis**: Flags leftover backup files (`.bak`, `.old`, etc.) still present in the project.
    *   **Code complexity analysis**: Measures the cyclomatic complexity of functions and classes.
    *   **Project structure analysis**: Checks whether the directory layout follows common best practices.
*   **Action plan**: Automatically generates a concrete refactoring plan (e.g. delete, move, or modify files) based on the analysis results.
*   **Safe execution**: Preview changes with a dry-run before applying them, and automatically back up every modified file before making any change.
*   **One-command rollback**: If the refactoring result is not what you expected, restore the project to its pre-execution state using the saved backup.
*   **Report output**: Generates a detailed HTML analysis report as well as a colour-coded terminal report.

## Project Structure

The repository contains several top-level directories:

*   `claude/`, `gemini/`, `codex/`: Python toolchain implementations generated by different large language models (LLMs). They are functionally equivalent — pick whichever one you prefer.
*   `PROMPTS/`: Contains the original prompts and build scripts used to generate the Python code above. Developers can use `PROMPTS/build.sh` to regenerate or customise the toolchain.

## Quick start (root Makefile)

The root `Makefile` provides shortcuts for the two fully-tested implementations (`claude/` and `codex/`):

```bash
# Install both implementations (creates .venv in each subdirectory)
make install

# Run the full test suite (claude + codex)
make test

# Run tests for one implementation only
make test-claude
make test-codex

# Run only unit tests (skip integration tests)
make test-unit-claude
make test-unit-codex
```

## Installation (manual)

Using the `claude` implementation as an example:

1.  **Enter the directory**:
    ```bash
    cd claude
    ```

2.  **Create a virtual environment** (recommended):
    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```

3.  **Install dependencies**:
    ```bash
    pip install -e .
    ```
    This installs the required packages (`click`, `rich`, `ijson`) and registers the `php-cleanup` command in your environment.

## Usage

The toolchain provides three commands: `analyze`, `execute`, and `rollback`.

### 1. Generate the scan report (`report.json`)

The `analyze` command requires a JSON report produced in advance by an **external PHP scanner** (not included in this toolchain). Run your scanner of choice against your PHP project:

```bash
# Example (exact syntax depends on your scanner):
<your-scanner> --project ~/projects/my-legacy-php-app --output report.json
```

Expected report format:

```json
{
  "summary": { "total_files": 342, "total_branches": 1850 },
  "files": {
    "app-content/themes/mytheme/functions.php": { "max_depth": 8, "total_branches": 64 }
  }
}
```

### 2. `analyze` — Analyse the report and build a plan

Reads the JSON report, performs a deep analysis, and produces a refactoring action plan (`action_plan.json`) together with an HTML report.

```bash
# Syntax:  php-cleanup analyze --report <report.json> --project-dir <path-to-php-project>
# Example:
php-cleanup analyze --report report.json --project-dir ~/projects/my-legacy-php-app
```

This command will:
*   Print a detailed analysis summary to the terminal.
*   Write `action_plan.json` — a list of all proposed refactoring actions.
*   Write `report.html` — a visual report you can open in any browser.

### 3. `execute` — Run the refactoring plan

Executes the actions listed in `action_plan.json`. **Dry-run mode is the default** — it prints what would happen without modifying any files.

```bash
# Dry run — preview changes only
# Syntax:  php-cleanup execute --plan <plan.json> --project-dir <path-to-php-project>
# Example:
php-cleanup execute --plan action_plan.json --project-dir ~/projects/my-legacy-php-app
```

Once you are satisfied with the preview, add the `--execute` flag to apply the changes for real.

```bash
# Live run — modifies files and creates automatic backups
# Syntax:  php-cleanup execute --plan <plan.json> --project-dir <path-to-php-project> --execute
# Example:
php-cleanup execute --plan action_plan.json --project-dir ~/projects/my-legacy-php-app --execute
```

After a live run, backups are stored under `~/.php-cleanup-backup/<timestamp>/` (e.g. `~/.php-cleanup-backup/20260227_123456/`). Note down this path — you will need it if you want to roll back.

### 4. `rollback` — Undo changes

If the result of `execute` is not what you expected, restore all modified files from the backup directory.

```bash
# Syntax:  php-cleanup rollback --backup-dir <backup-path> --project-dir <path-to-php-project>
# Example:
php-cleanup rollback --backup-dir ~/.php-cleanup-backup/20260227_123456 --project-dir ~/projects/my-legacy-php-app
```
> Restored 15 file(s) from ~/.php-cleanup-backup/20260227_123456

## Testing

Both `claude/` and `codex/` ship with a full pytest suite covering every module:

| Implementation | Tests | Coverage |
|---|---|---|
| `claude/` | 222 | core · analyzers · planners · executors · reporters · CLI |
| `codex/` | 222 | core · analyzers · planners · executors · reporters · CLI |

Run from the repo root:

```bash
make test          # both implementations
make test-claude   # claude only
make test-codex    # codex only
```

Or from within a subdirectory using its own Makefile:

```bash
cd claude && make test
cd codex  && make test
```

## Development

To modify or regenerate the toolchain code, see the `PROMPTS/` directory.

The `build.sh` script rebuilds all Python source files under `claude/`, `gemini/`, and `codex/` from the Markdown prompt files.

```bash
# Regenerate from the repo root
make build

# Or run build.sh directly
cd PROMPTS
./build.sh                  # defaults to claude
./build.sh --agent codex    # codex implementation
./build.sh --agent gemini   # gemini implementation
```
